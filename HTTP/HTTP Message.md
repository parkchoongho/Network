# HTTP 메시지

HTTP가 배달원이면, HTTP 메시지는 무언가를 담아 보내는 소포와 같습니다. 이에 대해 살펴보겠습니다.

### 3-1. 메시지의 흐름

HTTP 메시지는 HTTP 애플리케이션 간에 주고 받은 데이터의 블록들입니다. 이 데이터릐 블록들은 메시지의 내용과 의미를 설명하는 텍스트 메타 정보로 시작하고 그 다음에 선택적으로 데이터가 옵니다. 이 메시지는 클라이언트, 서버, 프락시 사이를 흐르게 됩니다. '인바운드', '아웃바운드', '업스트림', '다운스트림'은 메시지의 방향을 의미하는 용어입니다.

### 3-1-1. 메시지는 원 서버 방향을 인바운드하여 송신

HTTP는 인바운드와 아웃바운드라는 용어를 트랜잭션 방향을 표현하기 위해 사용합니다. 메시지가 원 서버로 향하는 것은 인바운드로 이동하는 것이고, 모든 처리가 끝난 뒤에 메시지가 사용자에게 돌아오는 것을 아웃바운드로 이동하는 것이라 합니다. 

### 3-1-2. 다운 스트림으로 흐르는 메시지

HTTP 메시지는 강물처럼 흐릅니다. 요청, 응답메시지 모두 다운스트림으로 흐릅니다. 메시지의 발송자는 수신자의 업스트림입니다. 요청에서는 클라이언트가 서버의 업스트림이라면, 응답에서는 서버가 클라이언트의 업스트림이 됩니다. 

### 3-2. 메시지의 각 부분

메시지는 시작줄, 헤더 블록, 본문 이렇게 3가지로 나뉘어집니다. 시작줄은 이것이 어떤 메시지에 관한 것인지 알려주고, 헤더 블록은 속성, 본문은 데이터를 담고 있습니다. 때에 따라, 본문은 없을 수도 있습니다. 시작줄과 헤더는 줄 단위로 분리된 아스키 문자열입니다. 각 줄은 캐리지 리턴과 개행 문자로 구성된 두 글자의 줄바꿈 문자열로 끝납니다. 이 줄바꿈 문자열을 'CRLF'라고 씁니다. 메시지 본문은 단순한 데이터 덩어리입니다. 시작줄이나 헤더와는 달리, 본문은 텍스트나 이진 데이터를 포함할 수도 있고 그냥 비어있을 수도 있습니다.

### 3-2-1. 메시지 문법

모든 HTTP 메시지는 요청과 응답으로 분류됩니다. 둘은 기본적으로 구조가 거의 같습니다. (시작줄이 조금 다릅니다.) 

**메서드**

클라이언트 측에서 서버가 리소스에 대해 수행해주길 바라는 동작을 의미합니다. 'GET', 'POST', 'HEAD'처럼 한 단어로 표현합니다. 

**요청 URL**

요청 대상이 되는 리소스를 지칭하는 완전한 URL 혹은 URL 경로 구성요소입니다. 서버는 URL에서 생략된 호스트와 포트번호를 자신을 가리키는 것으로 간주합니다.

**버전**

메시지에서 사용중인 HTTP 버전입니다. 형식은 아래와 같습니다.

`HTTP/<메이저>.<마이너>`

메이저와 마이너는 모두 정수입니다.

**상태코드**

요청 중에 어떤일이 일어났는지 설명하는 세 자리 숫자입니다. 각 코드의 첫 번째 자릿수는 상태의 일반적인 분류(성공, 에러 등)을 나타냅니다.

**사유 구절(reason-phrase)**

숫자로 된 상태 코드의 의미를 사람이 이해할 수 있게 짧게 설명해주는 문구입니다. 상태 코드 이후부터 줄바꿈 문자열까지가 사유 구절입니다. 사유 구절은 오직 사람에게 읽히기 위한 목적으로만 존재합니다.

**헤더**

이름, 콜론, 선택적 공백, 값, CRLF가 순서대로 나타나는 0개 이상의 헤더들. 이 헤더의 목록은 빈 줄(CRLF)로 끝나 헤더 목록의 끝과 본문의 시작을 표시합니다.

**엔터티 본문**

엔터티 본문은 임의의 데이터 블록을 포함합니다. 모든 메시지가 엔터티 본문을 가지는 것은 아니므로, 상황에 따라 메시지가 CRLF로 끝나기도 합니다. 

cf)  본문이 없을 경우 헤더 집합은 항상 빈줄로 끝나야하지만, 많은 클라이언트와 서버가 본문이 없는 경우 마지막 CRLF를 빠뜨리기도 합니다. 이렇게 규칙을 잘 지키지 않는 구현체와의 호환을 위해, 클라이언트와 서버는 마지막 CRLF 없이도 끝나는 메시지를 받을 수 있어야 합니다.

### 3-2-2. 시작줄

모든 HTTP 메시지는 시작줄로 시작하며 요청의 경우 무엇을 해야하는지 말해주고, 응답의 경우 무엇이 일어났는지 알려줍니다.

**요청줄**

요청 메시지 시작줄에는 어떤 동작이 일어나는지 설명하는 메서드와 그 동작 대상을 지칭하는 요청URL이 있습니다. 또한 클라이언트가 어떤 HTTP 버전으로 요청하는지 서버가 알 수 있게하는 HTTP 버전까지 포함됩니다. 이 모든 영역은 공백으로 구분합니다. 

```http
GET /test/hi-there.txt HTTP/1.1
Accept: text/*
Host: www.joes-hardware.com
```

여기서 요청 메서드는 GET이고 요청 URL은 /test/hi-there.txt, 버전은 HTTP/1.1입니다.

**응답줄**

응답 메시지 시작줄에는 응답 메시지에 쓰인 HTTP 버전, 숫자 상태 코드, 수행 상태에 대한 설명 텍스트가 들어갑니다. 마찬가지로 모든 필드는 공백으로 구분됩니다.

```http
HTTP/1.0 200 OK
Content-type: text/plain
Content-length: 19

Hi! I'm a message!
```

위 메시지를 봅시다. HTTP 버전은 HTTP/1.0이고 상태 코드는 200, 사유구절은 OK로 문서가 성공적으로 반환되었음을 뜻합니다.

**메서드**

HTTP 명세는 공통 요청 메서드 집합을 정의합니다. GET은 서버에서 문서를 가져오는 것이고, POST는 서버에서 처리했으면 하는 데이터를 보내는 것이고, OPTIONS 메서드는 웹 서버의 일반적인 지원 범위 혹은 웹 서버의 특정 리소스에 대한 지원 범위를 알아보는 것입니다.

| 메서드  | 설명                                                    | 메시지 본문 유무 |
| ------- | ------------------------------------------------------- | ---------------- |
| GET     | 서버에서 문서를 가져온다.                               | 무               |
| HEAD    | 서버에서 어떤 문서에 대한 헤더만 가져온다.              | 무               |
| POST    | 서버가 처리할 데이터를 보낸다.                          | 유               |
| PUT     | 서버에 요청 메시지의 본문을 저장한다.                   | 유               |
| TRACE   | 메시지가 프락시를 거쳐 서버에 도달하는 과정을 추적한다. | 무               |
| OPTIONS | 서버가 어떤 메서드를 수행할 수 있는지 확인한다.         | 무               |
| DELETE  | 서버에서 문서를 제거한다.                               | 무               |

**상태 코드**

상태코드는 클라이언트에게 어떤일이 일어났는지 알려줍니다. 클라이언트의 요청은 항상 성공적이지 만은 않습니다. 요청한 리소스가 없거나, 리소스 접근권한이 없거나, 리소스가 다른 장소로 옮겨지는 등 여러가지 에러상황이 존재합니다. 이에 대해 어떻게 처리를 했는지 알려주는 것이 바로 상태 코드입니다. 

상태코드들은 세자리 숫자로 된 코드값을 기준으로 묶이게 됩니다. 

| 전체 범위 | 정의된 범위 | 분류            |
| --------- | ----------- | --------------- |
| 100-199   | 100-101     | 정보            |
| 200-299   | 200-206     | 성공            |
| 300-399   | 300-305     | 리다이렉션      |
| 400-499   | 400-415     | 클라이언트 에러 |
| 500-599   | 500-505     | 서버 에러       |

밑에는 만날 수 있는 가장 흔한 상태 코드를 표로 정리한 것입니다.

| 상태 코드 | 사유 구절    | 의미                                             |
| --------- | ------------ | ------------------------------------------------ |
| 200       | OK           | 성공! 요청한 모든 데이터가 응답 본문에 들어있다. |
| 401       | Unauthorized | 사용자 이름과 비밀번호를 입력해야 한다.          |
| 404       | Not Found    | 서버는 요청 URL에 대한 리소스를 찾지 못했다.     |

**사유 구절**

사유 구절은 응답 메시지의 마지막 구성요소입니다. 사유 구절은 상태 코드와 일대일로 대응됩니다. 사유 구절은 상태 코드의 사람이 이해하기 쉬운 버전입니다. HTTP 명세에는 사유 구절이 어떻게 되야 한다는 엄격한 규칙을 제공하지 않습니다.

**버전번호**

버전 번호는 HTTP/x.y의 형태로 요청 응답 모두에 기술됩니다. 이것은 HTTP 애플리케이션이 상대방에게 자신이 따르는 프로토콜 버전이 무엇인지 알려주기 위한 수단입니다. 버전 번호는 HTTP로 대화하는 애플리케이션에게 대화 상대의 능력과 메시지 형식에 대한 단서를 제공하기 위한 것으로 생각하시면 됩니다.

### 3-2-3. 헤더

시작줄 다음에는 0개, 1개 혹은 여러 개의 HTTP 헤더가 옵니다. HTTP 헤더 필드는 요청과 응답 메시지에 추가적인 정보를 더해줍니다. 기본적으로 이름/값 으로 구성된 목록입니다.

**일반 헤더**

요청과 응답 양쪽에 모두 나타날 수 있음

**요청 헤더**

요청에 대한 부가 정보를 제공

**응답 헤더**

응답에 대한 부가 정보를 제공

**Entity 헤더**

본문 크기와 리소스 그 자체를 서술

**확장 헤더**

명세에 정의되지 않은 헤더

각 HTTP 헤더는 문법을 가지고 있습니다. 이름, 쉼표, 공백(없어도 상관 무), 필드 값, CRLF가 순서대로 옵니다. 밑에는 흔히 쓰이는 헤더의 예시를 표로 정리한 것입니다.

| 헤더 예시                                | 설명                                                     |
| ---------------------------------------- | -------------------------------------------------------- |
| Date: Tue, 3OCT 1997 02:16:03 GMT        | 서버가 응답을 만들어낸 시각                              |
| Content-length: 15040                    | 15,040 바이트의 데이터를 포함한 엔터티 본문              |
| Content-type: image/gif                  | 엔터티 본문은 GIF 이미지                                 |
| Accept: image/gif, image/jpeg, text/html | 클라이언트는 GIF, JPEG 이미지와 HTML을 받아들일 수 있다. |

**헤더를 여러 줄로 나누기**

긴 헤더 줄은 여러 줄로 쪼개서 더 읽기 좋게 만들 수 있는데, 추가 줄 앞에는 최소 하나의 스페이스 혹은 탭 문자가 와야합니다.

```http
HTTP/1.0 200 OK
Content-Type: image/gif
Content-Length: 8572
Server: Test Server
	Version 1.0

```

여기서 응답 메시지는 여러 줄로 쪼개진 Server 헤더를 포함하고 있습니다. 그 헤더의 완전한 값은 'Test Server Version 1.0'입니다.