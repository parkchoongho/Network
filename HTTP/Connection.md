# Connection 관리

HTTP 명세는 HTTP 메시지에 대해서는 자세히 설명하지만, HTTP 커넥션과 HTTP 메시지의 흐름에 대한 내용은 충분히 다루고 있지 않습니다. HTTP 애플리케이션을 개발하기 위해서는 HTTP 커넥션과 그것이 어떻게 사용되는지에 대한 이해가 충분히 되어있어야 합니다.

- HTTP는 어떻게 TCP 커넥션을 사용하는가
- TCP 커넥션의 지연, 병목, 막힘
- 병렬 커넥션, keep-alive 커넥션, 커넥션 파이프라인을 활용한 HTTP 최적화
- 커넥션 관리를 위해 따라야 할 규칙들

### 4-1. TCP 커넥션

전 세계 모든 HTTP 통신은 지구상 컴퓨터와 네트워크 장비에서 널리 쓰이는 패킷 교환 프로토콜들의 계층화된 집합인 TCP/IP를 통해 이루어집니다. 세계 어느 곳이건, 클라이언트 애플리케이션은 서버 애플리케이션과 TCP/IP 커넥션을 맺을 수 있습니다. 일단 커넥션이 맺어지면 클라이언트와 서버 간에 주고받는 메시지들은 손실 혹은 손상되거나 순서가 바뀌지 않고 안전하게 전달됩니다. 

http://www.joes-hardware.com:80/power-tools.html URL을 입력받은 브라우저는 총 7가지 단계를 수행합니다. 1 ~ 3 단계에서 URL에서 서버의 IP 주소와 포트 번호를 가져옵니다. 4단계에서 웹 서버가 TCP 커넥션을 맺고 5단계에서 그 커넥션을 통해 요청 메시지가 전달됩니다. 6단계에서 응답을 읽고 7단계에서 커넥션이 끊어지게 됩니다.

1. 브라우저가 www.joes-hardware.com 이라는 호스트 명을 추출합니다.
2. 브라우저가 이 호스트 명에 대한 IP 주소를 찾습니다.
3. 브라우저가 포트번호 (80)을 가져옵니다.
4. 브라우저가 202.43.78.3의 80 포트로 TCP 커넥션을 생성합니다.
5. 브라우저가 서버로 HTTP GET 요청 메시지를 보냅니다.
6. 브라우저가 서버에서 온 HTTP 응답 메시지를 읽습니다.
7. 브라우저가 커넥션을 끊습니다.

### 4-1-1. 신뢰할 수 있는 데이터 전송 통로인 TCP

 HTTP 커넥션은 몇몇 사용 규칙을 제외하고 TCP 커넥션에 불과합니다. TCP 커넥션은 인터넷을 안정적으로 연결해 줍니다. TCP는 HTTP에게 신뢰할 만한 통신 방식을 제공합니다. TCP 커넥션의 한쪽에 있는 바이트들은 반대쪽으로 순서에 맞게 정확히 전달됩니다.

### 4-1-2. TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전달

TCP는 IP 패킷이라 불리는 작은 조각을 통해 데이터를 전송합니다. HTTP는 'IP TCP HTTP'로 구성된 '프로토콜 스택'에서 최상위 계층입니다. HTTP에 보안 기능을 더한 HTTPS는 TLS 혹은 SSL이라 불리기도 하며 HTTP와 TCP 사이에 있는 암호화 계층입니다.

HTTP

|         HTTP (애플리케이션 계층)          |
| :---------------------------------------: |
|            **TCP (전송 계층)**            |
|          **IP (네트워크 계층)**           |
| **Network Interfaces (데이터 링크 계층)** |

HTTPS

|         HTTP (애플리케이션 계층)          |
| :---------------------------------------: |
|        **TLS or SSL (보안 계층)**         |
|            **TCP (전송 계층)**            |
|          **IP (네트워크 계층)**           |
| **Network Interfaces (데이터 링크 계층)** |

HTTP가 메시지를 전송하고자 할 경우, 현재 연결되어 있는 TCP 커넥션을 통해서 메시지 데이터의 내용을 순서대로 보내게 됩니다. TCP는 세그먼트 단위로 데이터 스트림을 잘게 나누고, 세그먼트를 IP 패킷이라 불리는 봉투에 담아 인터넷을 통해 전달합니다. 다시 말해, TCP 세그먼트는 하나의 IP 주소에서 다른 IP 주소로 IP 패킷에 담겨 전달됩니다. 이 IP 패킷들 각각은 다음을 포함합니다.

- IP 패킷 헤더
- TCP 세그먼트 헤더
- TCP 조각 데이터

IP헤더는 발신지와 목적지 IP 주소, 크기, 기타 플래그를 가집니다. TCP 세그먼트 헤더는 TCP 포트번호, TCP 제어 플래그, 그리고 데이터의 순서와 무결성을 검사하기 위해 사용되는 숫자 값을 포함합니다.

### 4-1-3. TCP 커넥션 유지하기

컴퓨터는 항상 TCP 커넥션을 여러개 가지고 있습니다. TCP는 포트 번호를 통해서 이런 여러개의 커넥션을 유지합니다. 포트 번호는 회사 내선번호와 같습니다. 회사 대표 전화번호는 안내 데스크로 연결되고 내선전화는 해당 직원으로 연결되듯이, IP 주소는 해당 컴퓨터에 연결되고 포트 번호는 해당 애플리케이션으로 연결됩니다. TCP 커넥션은 네가지 값으로 식별됩니다.

`<발신지 IP 주소, 발신지 포트, 수신지 IP 주소, 수신지 포트>`

이 네가지 값으로 유일한 커넥션을 생성합니다. 서로 다른 두 개의 TCP 커넥션은 네가지 주소 구성 요소의 값이 모두 같을 수 없습니다.



